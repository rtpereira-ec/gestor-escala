<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Escala e Visitas</title>
    <style>
        :root {
            --color-primary: #2184B1;
            --color-primary-hover: #1A6B94;
            --color-primary-active: #134E70;
            --color-success: #27AE60;
            --color-danger: #E74C3C;
            --color-warning: #F39C12;
            --color-info: #3498DB;
            --color-bg: #F5F5F5;
            --color-surface: #FFFFFF;
            --color-text: #2C3E50;
            --color-text-light: #7F8C8D;
            --color-border: #ECF0F1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* LOGIN SCREEN */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-active) 100%);
        }

        .login-box {
            background: var(--color-surface);
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: var(--color-primary);
            font-size: 28px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--color-text);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 132, 177, 0.1);
        }

        /* HEADER */
        header {
            background: var(--color-surface);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            color: var(--color-primary);
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-badge {
            background: var(--color-primary);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-border);
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-light);
            transition: all 0.3s;
        }

        .tab-btn.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-btn:hover {
            color: var(--color-primary);
        }

        /* BUTTONS */
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #C0392B;
        }

        .btn-secondary {
            background: var(--color-text-light);
            color: white;
        }

        .btn-secondary:hover {
            background: #556983;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* TABLES */
        .table-container {
            background: var(--color-surface);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #F8F9FA;
            border-bottom: 2px solid var(--color-border);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--color-text);
            font-size: 13px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-border);
            font-size: 13px;
        }

        tbody tr:hover {
            background: #F8F9FA;
        }

        /* FORMS */
        .form-section {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* CALENDAR */
        .calendar-container {
            background: var(--color-surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-cell {
            aspect-ratio: 1;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--color-bg);
        }

        .day-cell:hover {
            border-color: var(--color-primary);
            background: rgba(33, 132, 177, 0.05);
        }

        .day-cell.has-schedule {
            background: rgba(39, 174, 96, 0.1);
            border-color: var(--color-success);
            font-weight: 600;
            color: var(--color-success);
        }

        .day-cell.today {
            background: rgba(33, 132, 177, 0.1);
            border-color: var(--color-primary);
            font-weight: 600;
            color: var(--color-primary);
        }

        /* STATUS BADGES */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-visited {
            background: rgba(39, 174, 96, 0.2);
            color: var(--color-success);
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.2);
            color: var(--color-warning);
        }

        .status-scheduled {
            background: rgba(52, 152, 219, 0.2);
            color: var(--color-info);
        }

        /* HIDDEN */
        .hidden {
            display: none !important;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            header {
                flex-direction: column;
                gap: 15px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-wrap: wrap;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-container">
    <div class="login-box">
        <h1>üè¢ Gestor Escala</h1>
        <form id="loginForm">
            <div class="form-group">
                <label>Nome</label>
                <input type="text" id="userName" required placeholder="Seu nome">
            </div>
            <div class="form-group">
                <label>Tipo de Usu√°rio</label>
                <select id="userType" required>
                    <option value="">Selecione...</option>
                    <option value="coordenador">Coordenador</option>
                    <option value="colaborador">Colaborador</option>
                </select>
            </div>
            <button type="submit" class="btn-primary" style="width: 100%; margin-top: 20px;">Entrar</button>
        </form>
    </div>
</div>

<!-- APP -->
<div id="appScreen" class="hidden">
    <header>
        <div>
            <h1>üìÖ Gestor de Escala e Visitas</h1>
        </div>
        <div class="user-info">
            <span id="userDisplay"></span>
            <div class="user-badge" id="userRoleBadge"></div>
            <button class="btn-secondary btn-small" onclick="logout()">Sair</button>
        </div>
    </header>

    <div class="container">
        <!-- COORDENADOR VIEW -->
        <div id="coordenadorView" class="hidden">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('colaboradores', this)">üë• Colaboradores</button>
                <button class="tab-btn" onclick="switchTab('escala', this)">üìÖ Escala</button>
                <button class="tab-btn" onclick="switchTab('visitas', this)">üìç Visitas</button>
                <button class="tab-btn" onclick="switchTab('relatorios', this)">üìä Relat√≥rios</button>
            </div>

            <!-- COLABORADORES TAB -->
            <div id="colaboradoresTab" class="tab-content">
                <div class="form-section">
                    <h3>Cadastrar Colaborador</h3>
                    <form id="formColaborador">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nome</label>
                                <input type="text" id="colabNome" required placeholder="Nome do colaborador">
                            </div>
                            <div class="form-group">
                                <label>Telefone</label>
                                <input type="tel" id="colabTel" required placeholder="(XX) XXXXX-XXXX">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="colabEmail" required placeholder="email@exemplo.com">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Adicionar Colaborador</button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <h3 style="padding: 15px; border-bottom: 1px solid var(--color-border);">Lista de Colaboradores</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>Email</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaColaboradores"></tbody>
                    </table>
                </div>
            </div>

            <!-- ESCALA TAB -->
            <div id="escalasTab" class="tab-content hidden">
                <div class="form-section">
                    <h3>Lan√ßar Escala</h3>
                    <form id="formEscala">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Colaborador</label>
                                <select id="escalColaborador" required></select>
                            </div>
                            <div class="form-group">
                                <label>Data</label>
                                <input type="date" id="escalData" required>
                            </div>
                            <div class="form-group">
                                <label>Empreendimento</label>
                                <select id="escalEmpreendimento" required>
                                    <option value="">Selecione...</option>
                                    <option value="Tulipas">Tulipas</option>
                                    <option value="Girass√≥is">Girass√≥is</option>
                                    <option value="L√≥tus">L√≥tus</option>
                                    <option value="Bosque das Flores">Bosque das Flores</option>
                                    <option value="Azaleia">Azaleia</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Tipo</label>
                                <select id="escalTipo" required>
                                    <option value="">Selecione...</option>
                                    <option value="Visita">Visita Presencial</option>
                                    <option value="Folga">Folga</option>
                                    <option value="Reuni√£o">Reuni√£o</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Lan√ßar Escala</button>
                        </div>
                    </form>
                </div>

                <div class="table-container">
                    <h3 style="padding: 15px; border-bottom: 1px solid var(--color-border);">Escala Lan√ßada</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Data</th>
                                <th>Dia da Semana</th>
                                <th>Empreendimento</th>
                                <th>Tipo</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaEscala"></tbody>
                    </table>
                </div>
            </div>

            <!-- VISITAS TAB -->
            <div id="visitasTab" class="tab-content hidden">
                <div class="table-container">
                    <h3 style="padding: 15px; border-bottom: 1px solid var(--color-border);">Visitas Presenciais</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Data</th>
                                <th>Empreendimento</th>
                                <th>Leads Atendidos</th>
                                <th>Status</th>
                                <th>Observa√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaVisitas"></tbody>
                    </table>
                </div>
            </div>

            <!-- RELAT√ìRIOS TAB -->
            <div id="relatoriosTab" class="tab-content hidden">
                <div class="form-section">
                    <h3>Filtrar Relat√≥rio</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>M√™s</label>
                            <input type="month" id="filtroMes">
                        </div>
                        <div class="form-group">
                            <label>Colaborador</label>
                            <select id="filtroColabRel"></select>
                        </div>
                        <div class="form-group">
                            <label>Empreendimento</label>
                            <select id="filtroEmpRel">
                                <option value="">Todos</option>
                                <option value="Tulipas">Tulipas</option>
                                <option value="Girass√≥is">Girass√≥is</option>
                                <option value="L√≥tus">L√≥tus</option>
                                <option value="Bosque das Flores">Bosque das Flores</option>
                                <option value="Azaleia">Azaleia</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn-primary" onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
                    </div>
                </div>

                <div class="table-container" id="relatorioContainer" style="display: none;">
                    <div id="relatorioContent"></div>
                </div>
            </div>
        </div>

        <!-- COLABORADOR VIEW -->
        <div id="colaboradorView" class="hidden">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('minha-agenda', this)">üìÖ Minha Agenda</button>
                <button class="tab-btn" onclick="switchTab('registrar-visita', this)">üìç Registrar Visita</button>
                <button class="tab-btn" onclick="switchTab('minhas-visitas', this)">üìä Minhas Visitas</button>
            </div>

            <!-- MINHA AGENDA -->
            <div id="minhaAgendaTab" class="tab-content">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="btn-secondary btn-small" onclick="mesAnterior()">‚Üê Anterior</button>
                        <h3 id="mesAtualDisplay"></h3>
                        <button class="btn-secondary btn-small" onclick="proximoMes()">Pr√≥ximo ‚Üí</button>
                    </div>
                    <div class="calendar-grid" id="calendarioGrid"></div>
                </div>

                <div class="table-container" style="margin-top: 20px;">
                    <h3 style="padding: 15px; border-bottom: 1px solid var(--color-border);">Escala do M√™s</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Dia</th>
                                <th>Empreendimento</th>
                                <th>Tipo</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="minhaEscala"></tbody>
                    </table>
                </div>
            </div>

            <!-- REGISTRAR VISITA -->
            <div id="registrarVisitaTab" class="tab-content hidden">
                <div class="form-section">
                    <h3>Registrar Visita Presencial</h3>
                    <form id="formRegistroVisita">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Data da Visita</label>
                                <input type="date" id="visitaData" required>
                            </div>
                            <div class="form-group">
                                <label>Empreendimento</label>
                                <select id="visitaEmpresa" required>
                                    <option value="">Selecione...</option>
                                    <option value="Tulipas">Tulipas</option>
                                    <option value="Girass√≥is">Girass√≥is</option>
                                    <option value="L√≥tus">L√≥tus</option>
                                    <option value="Bosque das Flores">Bosque das Flores</option>
                                    <option value="Azaleia">Azaleia</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Nome do Lead</label>
                            <input type="text" id="visitaNomeLead" required placeholder="Nome da pessoa atendida">
                        </div>
                        <div class="form-group">
                            <label>Telefone</label>
                            <input type="tel" id="visitaTel" placeholder="(XX) XXXXX-XXXX">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="visitaEmail" placeholder="email@exemplo.com">
                        </div>
                        <div class="form-group">
                            <label>Status do Lead</label>
                            <select id="visitaStatus" required>
                                <option value="">Selecione...</option>
                                <option value="Interesse">Interesse</option>
                                <option value="Agendado">Agendado</option>
                                <option value="Venda Realizada">Venda Realizada</option>
                                <option value="Sem Interesse">Sem Interesse</option>
                                <option value="Aguardando Documentos">Aguardando Documentos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Observa√ß√µes</label>
                            <textarea id="visitaObs" rows="4" placeholder="Anota√ß√µes da visita..."></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Registrar Visita</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- MINHAS VISITAS -->
            <div id="minhasVisitasTab" class="tab-content hidden">
                <div class="table-container">
                    <h3 style="padding: 15px; border-bottom: 1px solid var(--color-border);">Hist√≥rico de Visitas</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Empreendimento</th>
                                <th>Lead</th>
                                <th>Status</th>
                                <th>Telefone</th>
                                <th>Observa√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="minhasVisitasTabela"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let usuarios = JSON.parse(localStorage.getItem('usuarios')) || [];
    let colaboradores = JSON.parse(localStorage.getItem('colaboradores')) || [];
    let escalas = JSON.parse(localStorage.getItem('escalas')) || [];
    let visitas = JSON.parse(localStorage.getItem('visitas')) || [];
    let usuarioLogado = null;
    let mesAtual = new Date();

    document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const nome = document.getElementById('userName').value;
        const tipo = document.getElementById('userType').value;

        usuarioLogado = { nome, tipo };
        localStorage.setItem('usuarioLogado', JSON.stringify(usuarioLogado));

        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appScreen').classList.remove('hidden');

        document.getElementById('userDisplay').textContent = `üë§ ${nome}`;
        document.getElementById('userRoleBadge').textContent = tipo === 'coordenador' ? 'COORDENADOR' : 'COLABORADOR';

        if (tipo === 'coordenador') {
            document.getElementById('coordenadorView').classList.remove('hidden');
            carregarColaboradores();
            preencherSelectColaboradores();
        } else {
            document.getElementById('colaboradorView').classList.remove('hidden');
            carregarMinhaAgenda();
        }
    });

    function logout() {
        localStorage.removeItem('usuarioLogado');
        location.reload();
    }

    function switchTab(tabName, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

        let tabElement = null;
        if (tabName === 'colaboradores') tabElement = document.getElementById('colaboradoresTab');
        else if (tabName === 'escala') tabElement = document.getElementById('escalasTab');
        else if (tabName === 'visitas') tabElement = document.getElementById('visitasTab');
        else if (tabName === 'relatorios') tabElement = document.getElementById('relatoriosTab');
        else if (tabName === 'minha-agenda') {
            tabElement = document.getElementById('minhaAgendaTab');
            carregarMinhaAgenda();
        }
        else if (tabName === 'registrar-visita') tabElement = document.getElementById('registrarVisitaTab');
        else if (tabName === 'minhas-visitas') {
            tabElement = document.getElementById('minhasVisitasTab');
            carregarMinhasVisitas();
        }

        if (tabElement) {
            tabElement.classList.remove('hidden');
            btn.classList.add('active');
        }
    }

    document.getElementById('formColaborador').addEventListener('submit', (e) => {
        e.preventDefault();
        const colab = {
            id: Date.now(),
            nome: document.getElementById('colabNome').value,
            tel: document.getElementById('colabTel').value,
            email: document.getElementById('colabEmail').value
        };
        colaboradores.push(colab);
        localStorage.setItem('colaboradores', JSON.stringify(colaboradores));
        document.getElementById('formColaborador').reset();
        carregarColaboradores();
        preencherSelectColaboradores();
    });

    function carregarColaboradores() {
        const tbody = document.getElementById('tabelaColaboradores');
        tbody.innerHTML = '';
        colaboradores.forEach(c => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${c.nome}</td>
                <td>${c.tel}</td>
                <td>${c.email}</td>
                <td>
                    <button class="btn-danger btn-small" onclick="removerColaborador(${c.id})">Remover</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function removerColaborador(id) {
        colaboradores = colaboradores.filter(c => c.id !== id);
        localStorage.setItem('colaboradores', JSON.stringify(colaboradores));
        carregarColaboradores();
        preencherSelectColaboradores();
    }

    function preencherSelectColaboradores() {
        const select = document.getElementById('escalColaborador');
        const selectRel = document.getElementById('filtroColabRel');
        select.innerHTML = '<option value="">Selecione...</option>';
        selectRel.innerHTML = '<option value="">Todos</option>';
        colaboradores.forEach(c => {
            const opt1 = document.createElement('option');
            opt1.value = c.id;
            opt1.textContent = c.nome;
            select.appendChild(opt1);

            const opt2 = document.createElement('option');
            opt2.value = c.id;
            opt2.textContent = c.nome;
            selectRel.appendChild(opt2);
        });
    }

    document.getElementById('formEscala').addEventListener('submit', (e) => {
        e.preventDefault();
        const colabId = document.getElementById('escalColaborador').value;
        const colabNome = colaboradores.find(c => c.id == colabId)?.nome;
        const data = new Date(document.getElementById('escalData').value);
        const dias = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
        const diaSemana = dias[data.getDay()];

        const escala = {
            id: Date.now(),
            colabId: parseInt(colabId),
            colabNome: colabNome,
            data: document.getElementById('escalData').value,
            diaSemana: diaSemana,
            empreendimento: document.getElementById('escalEmpreendimento').value,
            tipo: document.getElementById('escalTipo').value
        };
        escalas.push(escala);
        localStorage.setItem('escalas', JSON.stringify(escalas));
        document.getElementById('formEscala').reset();
        carregarEscala();
    });

    function carregarEscala() {
        const tbody = document.getElementById('tabelaEscala');
        tbody.innerHTML = '';
        escalas.forEach(e => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${e.colabNome}</td>
                <td>${new Date(e.data).toLocaleDateString('pt-BR')}</td>
                <td>${e.diaSemana}</td>
                <td>${e.empreendimento}</td>
                <td>${e.tipo}</td>
                <td>
                    <button class="btn-danger btn-small" onclick="removerEscala(${e.id})">Remover</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function removerEscala(id) {
        escalas = escalas.filter(e => e.id !== id);
        localStorage.setItem('escalas', JSON.stringify(escalas));
        carregarEscala();
    }

    function carregarVisitasCoordenador() {
        const tbody = document.getElementById('tabelaVisitas');
        tbody.innerHTML = '';
        escalas.forEach(e => {
            const visitasDoEvento = visitas.filter(v => v.colabId === e.colabId && v.data === e.data && v.empreendimento === e.empreendimento);
            const status = visitasDoEvento.length > 0 ? 'Conclu√≠da' : 'Pendente';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${e.colabNome}</td>
                <td>${new Date(e.data).toLocaleDateString('pt-BR')}</td>
                <td>${e.empreendimento}</td>
                <td>${visitasDoEvento.length}</td>
                <td><span class="status-badge ${status === 'Conclu√≠da' ? 'status-visited' : 'status-pending'}">${status}</span></td>
                <td>${visitasDoEvento.map(v => v.obs).join(' | ')}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function carregarMinhaAgenda() {
        const colab = usuarioLogado;
        const colabObj = colaboradores.find(c => c.nome === colab.nome);
        
        if (!colabObj) return;

        const m√™s = mesAtual.getMonth();
        const ano = mesAtual.getFullYear();
        const primeiroDia = new Date(ano, m√™s, 1).getDay();
        const diasNoMes = new Date(ano, m√™s + 1, 0).getDate();

        document.getElementById('mesAtualDisplay').textContent = mesAtual.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

        const grid = document.getElementById('calendarioGrid');
        grid.innerHTML = '';

        for (let i = 0; i < primeiroDia; i++) {
            grid.appendChild(document.createElement('div'));
        }

        const hoje = new Date();
        for (let dia = 1; dia <= diasNoMes; dia++) {
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            const dataStr = `${ano}-${String(m√™s + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
            const escalaNoDia = escalas.filter(e => e.colabId === colabObj.id && e.data === dataStr);

            if (escalaNoDia.length > 0) {
                cell.classList.add('has-schedule');
                cell.innerHTML = `<strong>${dia}</strong><br><small>${escalaNoDia[0].empreendimento}</small>`;
            } else {
                cell.innerHTML = `<strong>${dia}</strong>`;
            }

            if (hoje.getDate() === dia && hoje.getMonth() === m√™s && hoje.getFullYear() === ano) {
                cell.classList.add('today');
            }

            grid.appendChild(cell);
        }

        const tbody = document.getElementById('minhaEscala');
        tbody.innerHTML = '';
        const minhasEscalas = escalas.filter(e => e.colabId === colabObj.id && 
            new Date(e.data).getMonth() === m√™s && 
            new Date(e.data).getFullYear() === ano
        );
        minhasEscalas.sort((a, b) => new Date(a.data) - new Date(b.data));

        minhasEscalas.forEach(e => {
            const visitaRealizada = visitas.find(v => v.colabId === e.colabId && v.data === e.data && v.empreendimento === e.empreendimento);
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${new Date(e.data).toLocaleDateString('pt-BR')}</td>
                <td>${e.diaSemana}</td>
                <td>${e.empreendimento}</td>
                <td>${e.tipo}</td>
                <td><span class="status-badge ${visitaRealizada ? 'status-visited' : 'status-scheduled'}">${visitaRealizada ? 'Conclu√≠da' : 'Agendada'}</span></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function mesAnterior() {
        mesAtual.setMonth(mesAtual.getMonth() - 1);
        carregarMinhaAgenda();
    }

    function proximoMes() {
        mesAtual.setMonth(mesAtual.getMonth() + 1);
        carregarMinhaAgenda();
    }

    document.getElementById('formRegistroVisita').addEventListener('submit', (e) => {
        e.preventDefault();
        const colab = usuarioLogado;
        const colabObj = colaboradores.find(c => c.nome === colab.nome);

        const visita = {
            id: Date.now(),
            colabId: colabObj.id,
            colabNome: colabObj.nome,
            data: document.getElementById('visitaData').value,
            empreendimento: document.getElementById('visitaEmpresa').value,
            nomeLead: document.getElementById('visitaNomeLead').value,
            tel: document.getElementById('visitaTel').value,
            email: document.getElementById('visitaEmail').value,
            status: document.getElementById('visitaStatus').value,
            obs: document.getElementById('visitaObs').value
        };
        visitas.push(visita);
        localStorage.setItem('visitas', JSON.stringify(visitas));
        document.getElementById('formRegistroVisita').reset();
        carregarVisitasCoordenador();
        carregarMinhaAgenda();
    });

    function carregarMinhasVisitas() {
        const colab = usuarioLogado;
        const colabObj = colaboradores.find(c => c.nome === colab.nome);
        
        if (!colabObj) return;

        const tbody = document.getElementById('minhasVisitasTabela');
        tbody.innerHTML = '';
        const minhasVis = visitas.filter(v => v.colabId === colabObj.id);
        minhasVis.sort((a, b) => new Date(b.data) - new Date(a.data));

        minhasVis.forEach(v => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${new Date(v.data).toLocaleDateString('pt-BR')}</td>
                <td>${v.empreendimento}</td>
                <td>${v.nomeLead}</td>
                <td><span class="status-badge status-visited">${v.status}</span></td>
                <td>${v.tel}</td>
                <td>${v.obs}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function gerarRelatorio() {
        const mes = document.getElementById('filtroMes').value;
        const colabId = document.getElementById('filtroColabRel').value;
        const empreendimento = document.getElementById('filtroEmpRel').value;

        let escalasFiltr = escalas;
        let visitasFiltr = visitas;

        if (mes) {
            const [ano, m√™s] = mes.split('-');
            escalasFiltr = escalasFiltr.filter(e => {
                const d = new Date(e.data);
                return d.getFullYear() == ano && String(d.getMonth() + 1).padStart(2, '0') === m√™s;
            });
            visitasFiltr = visitasFiltr.filter(v => {
                const d = new Date(v.data);
                return d.getFullYear() == ano && String(d.getMonth() + 1).padStart(2, '0') === m√™s;
            });
        }

        if (colabId) {
            escalasFiltr = escalasFiltr.filter(e => e.colabId == colabId);
            visitasFiltr = visitasFiltr.filter(v => v.colabId == colabId);
        }

        if (empreendimento) {
            escalasFiltr = escalasFiltr.filter(e => e.empreendimento === empreendimento);
            visitasFiltr = visitasFiltr.filter(v => v.empreendimento === empreendimento);
        }

        let html = '<h3>Relat√≥rio de Atividades</h3>';
        html += `<p>Per√≠od: ${mes || 'Todos'} | Colaborador: ${colabId ? colaboradores.find(c => c.id == colabId)?.nome : 'Todos'} | Empreendimento: ${empreendimento || 'Todos'}</p>`;
        html += `<hr><p><strong>Total de Dias Agendados:</strong> ${escalasFiltr.length}</p>`;
        html += `<p><strong>Total de Visitas Registradas:</strong> ${visitasFiltr.length}</p>`;
        html += `<table style="width: 100%; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #ccc;">
                        <th style="padding: 8px; text-align: left;">Colaborador</th>
                        <th style="padding: 8px; text-align: left;">Data</th>
                        <th style="padding: 8px; text-align: left;">Empreendimento</th>
                        <th style="padding: 8px; text-align: left;">Lead</th>
                        <th style="padding: 8px; text-align: left;">Status</th>
                    </tr>`;

        visitasFiltr.forEach(v => {
            html += `<tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">${v.colabNome}</td>
                        <td style="padding: 8px;">${new Date(v.data).toLocaleDateString('pt-BR')}</td>
                        <td style="padding: 8px;">${v.empreendimento}</td>
                        <td style="padding: 8px;">${v.nomeLead}</td>
                        <td style="padding: 8px;">${v.status}</td>
                    </tr>`;
        });

        html += '</table>';
        document.getElementById('relatorioContent').innerHTML = html;
        document.getElementById('relatorioContainer').style.display = 'block';
    }

    window.addEventListener('load', () => {
        const usuarioLogado = localStorage.getItem('usuarioLogado');
        if (usuarioLogado) {
            const user = JSON.parse(usuarioLogado);
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('appScreen').classList.remove('hidden');
            document.getElementById('userDisplay').textContent = `üë§ ${user.nome}`;
            document.getElementById('userRoleBadge').textContent = user.tipo === 'coordenador' ? 'COORDENADOR' : 'COLABORADOR';
            usuarioLogado = user;

            if (user.tipo === 'coordenador') {
                document.getElementById('coordenadorView').classList.remove('hidden');
                carregarColaboradores();
                carregarEscala();
                carregarVisitasCoordenador();
                preencherSelectColaboradores();
            } else {
                document.getElementById('colaboradorView').classList.remove('hidden');
                carregarMinhaAgenda();
            }
        }
    });
</script>

</body>
</html>